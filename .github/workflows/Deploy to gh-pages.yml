name: Deploy ClickOnce App

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  # 1. Build & Restore
  build-and-restore:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          lfs: false
          submodules: true

      - name: Disable CRLF conversions
        run: git config --global core.autocrlf false

      - name: Restore Google service account key
        shell: pwsh
        env:
          KEY_JSON_B64: ${{ secrets.GOOGLE_KEY_JSON_BASE64 }}
        run: |
          Write-Host "Decoding service account key into Resources/service-account-key.json"
          New-Item -ItemType Directory -Path AccraRoadAttendance\Resources -Force | Out-Null
          [System.IO.File]::WriteAllBytes(
            "AccraRoadAttendance\Resources\service-account-key.json",
            [System.Convert]::FromBase64String($Env:KEY_JSON_B64)
          )

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 8.0.x

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v1

      - name: Clean
        run: msbuild /t:Clean /p:Configuration=Release

      - name: Restore
        run: msbuild /t:Restore /p:Configuration=Release

  # 2. Publish ClickOnce
  publish:
    runs-on: windows-latest
    needs: build-and-restore
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 8.0.x

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v1

      - name: Restore (for Publish)
        run: msbuild /t:Restore /p:Configuration=Release

      - name: Publish Using ClickOnce Profile
        run: |
          msbuild /t:Publish \
            /p:PublishProfile=ClickOnceProfile \
            /p:Configuration=Release \
            /p:Revision=${{ github.run_number }}

      - name: Add .nojekyll and .gitattributes
        run: |
          New-Item -Path "AccraRoadAttendance/Installer/.nojekyll" -ItemType File -Force
          New-Item -Path "AccraRoadAttendance/Installer/.gitattributes" -ItemType File -Force -Value @"
          *.manifest binary
          *.application binary
          *.config binary
          *.dll binary
          "@

      - name: Validate Output Structure
        run: |
          Test-Path -Path "AccraRoadAttendance/Installer/Application Files/*" -PathType Container
          Test-Path -Path "AccraRoadAttendance/Installer/*.application"

  # 3. Deploy to GitHub Pages
  deploy:
    runs-on: ubuntu-latest
    needs: publish
    steps:
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          publish_dir: ./AccraRoadAttendance/Installer
          keep_files: false
          force_orphan: true
