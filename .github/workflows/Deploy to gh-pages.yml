name: Deploy ClickOnce App

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 8.0.x # Match your .NET version

    - name: Update Chocolatey
      run: |
        choco upgrade chocolatey --yes

    - name: Install Visual Studio Build Tools
      run: |
        for ($i = 1; $i -le 3; $i++) {
            choco install visualstudio2022-buildtools --include-optional --yes; if ($?) { break } else { Write-Host "Retry $i" }
        }
      shell: pwsh
      env:
        CHOCO_LOG_LEVEL: debug # Enable debug logging for Chocolatey

    - name: Verify MSBuild Installation
      run: |
        where msbuild

    - name: Publish Using ClickOnce Profile
      run: |
        # Use YOUR publish profile
        msbuild /t:Restore /p:Configuration=Release
        msbuild /t:Publish /p:PublishProfile=ClickOnceProfile /p:Configuration=Release

    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./publish  # GitHub Actions uses THIS folder (not your C:\ path)
        keep_files: false
